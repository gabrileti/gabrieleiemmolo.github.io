<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>FitTracker</title>
    <style>
        :root {
            --brand-primary: #7700ff;
            --ios-blue: #0A84FF;
            --ios-green: #30D158;
            --ios-orange: #FF9F0A;
            --ios-red: #FF453A;
            --label-primary: #FFFFFF;
            --label-secondary: #EBEBF599;
            --label-tertiary: #EBEBF54D;
            --fill-primary: #76768029;
            --fill-secondary: #76768024;
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-tertiary: #2C2C2E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            min-height: 100vh;
            color: var(--label-primary);
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 34px;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--ios-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 16px;
            color: var(--label-secondary);
        }

        /* Auth Screen */
        .auth-container {
            margin-top: 50px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .auth-title {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 15px;
            color: var(--label-secondary);
        }
        .auth-switch button {
            background: none; border: none; color: var(--ios-blue);
            font-weight: 600; font-size: 15px; cursor: pointer;
        }

        /* --- Form Group with Labels --- */
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            color: var(--label-secondary);
            margin-bottom: 8px;
            padding-left: 4px;
        }
        .form-group .form-control {
            width: 100%;
        }

        .form-control {
            padding: 14px 18px;
            background: var(--fill-primary);
            border: 1px solid transparent;
            border-radius: 12px;
            font-size: 16px;
            color: var(--label-primary);
            transition: all 0.2s ease;
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }
        .form-control::placeholder { color: var(--label-tertiary); }
        .form-control:focus {
            outline: none;
            border-color: var(--brand-primary);
            background: var(--bg-tertiary);
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-out;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--ios-blue); color: white; }
        .btn-danger { background: var(--ios-red); color: white; }

        /* User Info Header */
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 14px;
            margin-bottom: 24px;
        }
        .logout-btn {
            background: var(--fill-primary); color: var(--ios-red);
            border: none; padding: 8px 12px; border-radius: 8px;
            cursor: pointer; font-size: 14px; font-weight: 500;
        }

        /* Tabs (Segmented Control style) */
        .tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 24px;
        }
        .tab-btn {
            flex: 1; padding: 10px; background: none; border: none;
            border-radius: 9px; font-size: 15px; font-weight: 600;
            cursor: pointer; color: var(--label-secondary);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .tab-btn.active {
            background: var(--brand-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        /* Cards */
        .section-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .section-title {
            font-size: 22px; font-weight: 700;
            margin-bottom: 20px; color: var(--label-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-bar {
            background: var(--fill-primary); height: 8px;
            border-radius: 4px; overflow: hidden; margin: 12px 0;
        }
        .progress-fill {
            background: var(--ios-blue); height: 100%;
            border-radius: 4px; transition: width 0.4s ease; width: 0%;
        }
        .progress-text { font-size: 20px; font-weight: 600; text-align: center; }
        .progress-subtitle { font-size: 15px; color: var(--label-secondary); text-align: center; }


        /* Item Lists (Exercises, Food, Archives) */
        .item-list .item {
            background: var(--bg-tertiary);
            border-radius: 16px; padding: 16px;
            margin-bottom: 12px; border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .item-header {
            display: flex; justify-content: space-between;
            align-items: flex-start; margin-bottom: 8px;
        }
        .item-name {
            font-size: 17px; font-weight: 600; color: var(--label-primary);
            display: flex; align-items: center; gap: 8px;
            flex-grow: 1;
            padding-right: 10px;
        }
        .item-details { color: var(--label-secondary); font-size: 15px; line-height: 1.4; }
        .item-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .action-btn {
            background: var(--fill-primary); border: none; border-radius: 8px;
            width: 36px; height: 36px; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-edit { color: var(--ios-orange); }
        .btn-delete { color: var(--ios-red); }

        /* Session View */
        .session-item { cursor: pointer; }
        .session-item.completed {
            background: rgba(48, 209, 88, 0.15);
            border-color: rgba(48, 209, 88, 0.3);
        }
        .sets-progress { display: flex; gap: 4px; margin-top: 12px; }
        .set-indicator {
            height: 8px; flex: 1; border-radius: 4px;
            background: var(--fill-primary); transition: all 0.3s ease;
        }
        .set-indicator.completed { background: var(--ios-green); }
        .exercise-status, .food-status { font-size: 14px; color: var(--label-secondary); font-weight: 500;}

        /* Day Filters */
        .day-filter {
            display: flex; gap: 8px; margin-bottom: 20px;
            overflow-x: auto; padding-bottom: 4px; scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .day-filter::-webkit-scrollbar { display: none; }
        .day-btn {
            padding: 8px 16px; border: 1px solid var(--fill-primary);
            border-radius: 20px; background: var(--bg-tertiary);
            color: var(--label-secondary); font-weight: 600; cursor: pointer;
            transition: all 0.2s ease; white-space: nowrap; flex-shrink: 0;
        }
        .day-btn.active {
            background: var(--ios-blue); color: white; border-color: var(--ios-blue);
        }

        /* --- Toast Notification --- */
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 24px;
            border-radius: 14px;
            background: var(--bg-tertiary);
            color: var(--label-primary);
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .toast.show { bottom: calc(env(safe-area-inset-bottom, 0px) + 20px); }
        .toast.success { background: var(--ios-green); color: white; }
        .toast.error { background: var(--ios-red); color: white; }

        /* --- Loading Spinner --- */
        .loading { display: none; align-items: center; justify-content: center; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 9999; }
        .spinner {
            width: 32px; height: 32px;
            border: 4px solid var(--fill-secondary);
            border-top-color: var(--brand-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Modal for Editing & Confirmation --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 998; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: var(--bg-secondary); border-radius: 20px;
            padding: 24px; width: calc(100% - 32px); max-width: 400px;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 600; }
        .btn-close-modal { background: none; border: none; color: var(--label-secondary); font-size: 24px; cursor: pointer; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--label-secondary); }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }

        .day-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--label-secondary);
            padding: 12px 4px;
            margin-top: 16px;
            border-bottom: 1px solid var(--fill-primary);
        }
        
        .btn-archive {
             background: var(--fill-primary);
             color: var(--ios-blue);
             font-size: 14px;
             font-weight: 500;
             padding: 8px 12px;
             width: auto;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none !important; }

        @media (max-width: 380px) {
            .tab-label { display: none; }
            .tab-btn { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-screen">
            <div class="auth-container">
                <h2 class="auth-title">FitTracker</h2>
                <div id="login-section">
                    <h3 style="text-align:center; color: var(--label-secondary); font-weight: 500; margin-bottom:20px;">Accedi</h3>
                    <div class="form-group"><input type="email" id="login-email" class="form-control" placeholder="Email" required autocomplete="email"></div>
                    <div class="form-group"><input type="password" id="login-password" class="form-control" placeholder="Password" required autocomplete="current-password"></div>
                    <button id="login-btn" onclick="loginUser()" class="btn btn-primary">Accedi</button>
                    <div class="auth-switch">Non hai un account? <button onclick="switchToRegister()">Registrati</button></div>
                </div>
                <div id="register-form" class="hidden">
                    <h3 style="text-align:center; color: var(--label-secondary); font-weight: 500; margin-bottom:20px;">Crea Account</h3>
                    <div class="form-group"><input type="email" id="register-email" class="form-control" placeholder="Email" required autocomplete="email"></div>
                    <div class="form-group"><input type="password" id="register-password" class="form-control" placeholder="Password (min 6 caratteri)" required autocomplete="new-password"></div>
                    <div class="form-group"><input type="password" id="register-password-confirm" class="form-control" placeholder="Conferma Password" required autocomplete="new-password"></div>
                    <button id="register-btn" onclick="registerUser()" class="btn btn-primary">Registrati</button>
                    <div class="auth-switch">Hai gi√† un account? <button onclick="switchToLogin()">Accedi</button></div>
                </div>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <header class="header">
                <div class="user-info">
                    <span>üëã Ciao, <span id="user-email"></span></span>
                    <button onclick="logoutUser()" class="logout-btn">Esci</button>
                </div>
                <h1>FitTracker</h1>
                <p>Monitora allenamento e dieta.</p>
            </header>
            
            <div id="loading"><div class="spinner"></div></div>

            <nav class="tabs">
                <button class="tab-btn" onclick="showTab('session')">‚ö°Ô∏è<span class="tab-label">Sessione</span></button>
                <button class="tab-btn active" onclick="showTab('workout')">üèãÔ∏è‚Äç‚ôÇÔ∏è<span class="tab-label">Scheda</span></button>
                <button class="tab-btn" onclick="showTab('diet')">ü•ó<span class="tab-label">Dieta</span></button>
                <button class="tab-btn" onclick="showTab('dietsession')">üìä<span class="tab-label">Dieta Oggi</span></button>
                <button class="tab-btn" onclick="showTab('history')">üìú<span class="tab-label">Storico</span></button>
            </nav>

            <div id="session-tab" class="tab-content">
                 <section class="section-card">
                    <h2 class="section-title">üìÖ Seleziona Giorno</h2>
                    <div class="day-filter" id="session-day-filter"></div>
                </section>
                <section class="section-card">
                     <div class="session-progress">
                        <div class="progress-text" id="session-progress-text">0 / 0 completati</div>
                        <div class="progress-bar"><div class="progress-fill" id="session-progress-fill"></div></div>
                        <div class="progress-subtitle" id="session-day-text">Seleziona un giorno</div>
                    </div>
                    <div id="session-exercises" class="item-list"></div>
                    <button id="reset-session-btn" class="btn hidden" style="background:var(--ios-orange); color:white; margin-top:20px;" onclick="resetSession()">üîÑ Reset Sessione</button>
                </section>
            </div>

             <div id="dietsession-tab" class="tab-content">
                 <section class="section-card">
                    <h2 class="section-title">üìÖ Seleziona Giorno</h2>
                    <div class="day-filter" id="dietsession-day-filter"></div>
                </section>
                <section class="section-card">
                     <div class="dietsession-progress">
                        <div class="progress-text" id="diet-progress-text">0 / 0 completati</div>
                        <div class="progress-bar"><div class="progress-fill" id="diet-progress-fill"></div></div>
                        <div class="progress-subtitle" id="dietsession-day-text">Seleziona un giorno</div>
                    </div>
                    <div id="session-diet" class="item-list"></div>
                    <button id="reset-diet-session-btn" class="btn hidden" style="background:var(--ios-orange); color:white; margin-top:20px;" onclick="resetDietSession()">üîÑ Reset Dieta</button>
                </section>
            </div>

            <div id="workout-tab" class="tab-content active">
                <section class="section-card">
                    <h2 class="section-title">üí™ Aggiungi Esercizio</h2>
                    <div class="form-group"><label for="exercise-day">Giorno</label><select id="exercise-day" class="form-control"></select></div>
                    <div class="form-group"><label for="exercise-name">Nome Esercizio</label><input type="text" id="exercise-name" class="form-control" placeholder="Es. Panca Piana"></div>
                    <div style="display:flex; gap:12px;">
                        <div class="form-group" style="flex:1;"><label for="exercise-sets">Serie</label><input type="number" id="exercise-sets" class="form-control" placeholder="4"></div>
                        <div class="form-group" style="flex:1;"><label for="exercise-reps">Ripetizioni</label><input type="text" id="exercise-reps" class="form-control" placeholder="8-10"></div>
                        <div class="form-group" style="flex:1;"><label for="exercise-order">Ordine</label><input type="number" id="exercise-order" class="form-control" placeholder="1"></div>
                    </div>
                    <button onclick="addExercise()" class="btn btn-primary">Aggiungi Esercizio</button>
                </section>
                <section class="section-card">
                    <h2 class="section-title">
                        <span>üìñ La Tua Scheda</span>
                        <button class="btn btn-archive" onclick="confirmArchive()">Storicizza</button>
                    </h2>
                    <div class="day-filter" id="workout-day-filter"></div>
                    <div id="exercises-list" class="item-list"></div>
                </section>
            </div>

            <div id="diet-tab" class="tab-content">
                <section class="section-card">
                    <h2 class="section-title">ü•ó Aggiungi Alimento</h2>
                    <div class="form-group"><label for="food-day">Giorno</label><select id="food-day" class="form-control"></select></div>
                    <div class="form-group"><label for="food-name">Nome Alimento</label><input type="text" id="food-name" class="form-control" placeholder="Es. Petto di Pollo"></div>
                    <div style="display:flex; gap:12px;">
                        <div class="form-group" style="flex:1;"><label for="food-quantity">Quantit√† (g)</label><input type="number" id="food-quantity" class="form-control" placeholder="150"></div>
                        <div class="form-group" style="flex:1;"><label for="food-pasto">Pasto</label><input type="text" id="food-pasto" class="form-control" placeholder="Pranzo"></div>
                    </div>
                     <div style="display:flex; gap:12px;">
                        <div class="form-group" style="flex:1;"><label for="food-protein">Proteine (g)</label><input type="number" id="food-protein" class="form-control" placeholder="30"></div>
                        <div class="form-group" style="flex:1;"><label for="food-carbs">Carboidrati (g)</label><input type="number" id="food-carbs" class="form-control" placeholder="5"></div>
                    </div>
                    <button onclick="addFood()" class="btn btn-primary">Aggiungi Alimento</button>
                </section>
                 <section class="section-card">
                    <h2 class="section-title">üçΩÔ∏è Il Tuo Piano Alimentare</h2>
                    <div class="day-filter" id="food-day-filter"></div>
                    <div id="foods-list" class="item-list"></div>
                </section>
            </div>

            <div id="history-tab" class="tab-content">
                <section class="section-card">
                    <h2 class="section-title">üìú Storico Allenamenti</h2>
                    <div id="archive-list" class="item-list"></div>
                </section>
            </div>
        </div>

        <div id="toast" class="toast"></div>

        <div id="edit-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title" class="modal-title">Modifica</h3>
                    <button class="btn-close-modal" onclick="closeModal()">√ó</button>
                </div>
                <div id="modal-body"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, updateDoc, writeBatch, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAXxuBCf56hcmhoWj5edAx1YXWY6aPTZvY",
            authDomain: "trackerfit-e75d2.firebaseapp.com",
            projectId: "trackerfit-e75d2",
            storageBucket: "trackerfit-e75d2.appspot.com",
            messagingSenderId: "796343470243",
            appId: "1:796343470243:web:7e113f2a414f3f66219716"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let exercises = [], foods = [], completedSets = {}, completedFoods = [];
        let sessionExercises = [], sessionFood = [];
        let currentUser, currentDayFilter = 'all', currentFoodDayFilter = 'all';
        let currentSessionDay = null, currentDietSessionDay = null;
        let editingItem = { id: null, type: null };

        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        // --- UTILITY FUNCTIONS ---
        function triggerHapticFeedback() { if (navigator.vibrate) navigator.vibrate(50); }
        function showToast(message, type = 'info') {
            const toast = $('#toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 2800);
        }
        function showLoading(show) { $('#loading').style.display = show ? 'flex' : 'none'; }
        const getDayName = (d) => ({lunedi:'Luned√¨',martedi:'Marted√¨',mercoledi:'Mercoled√¨',giovedi:'Gioved√¨',venerdi:'Venerd√¨',sabato:'Sabato',domenica:'Domenica'}[d]||d);
        
        // --- AUTH FUNCTIONS ---
        async function loginUser() {
            const btn = $('#login-btn');
            btn.disabled = true;
            try { await signInWithEmailAndPassword(auth, $('#login-email').value, $('#login-password').value); } 
            catch (e) { showToast('Email o password errati.', 'error'); }
            finally { btn.disabled = false; }
        }
        async function registerUser() {
            const btn = $('#register-btn');
            btn.disabled = true;
            const [email, pass, conf] = [$('#register-email').value, $('#register-password').value, $('#register-password-confirm').value];
            if (!email || !pass || !conf) { btn.disabled = false; return showToast('Compila tutti i campi.', 'error'); }
            if (pass !== conf) { btn.disabled = false; return showToast('Le password non coincidono.', 'error'); }
            if (pass.length < 6) { btn.disabled = false; return showToast('Password troppo corta (min 6).', 'error'); }
            try { await createUserWithEmailAndPassword(auth, email, pass); } 
            catch (e) { showToast(e.message, 'error'); }
            finally { btn.disabled = false; }
        }
        async function logoutUser() { await signOut(auth); }
        function switchToRegister() { $('#login-section').classList.add('hidden'); $('#register-form').classList.remove('hidden'); }
        function switchToLogin() { $('#register-form').classList.add('hidden'); $('#login-section').classList.remove('hidden'); }

        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user;
                $('#auth-screen').classList.add('hidden');
                $('#main-app').classList.remove('hidden');
                $('#user-email').textContent = user.email.split('@')[0];
                showLoading(true);
                await Promise.all([loadExercises(), loadFoods(), loadArchivedWorkouts()]);
                showLoading(false);
            } else {
                currentUser = null;
                $('#main-app').classList.add('hidden');
                $('#auth-screen').classList.remove('hidden');
            }
        });

        // --- MODAL & EDIT FUNCTIONS ---
        function openModal(title, content) {
            $('#modal-title').textContent = title;
            $('#modal-body').innerHTML = content;
            $('#edit-modal').classList.add('active');
        }
        function closeModal() {
            $('#edit-modal').classList.remove('active');
            editingItem = { id: null, type: null };
        }

        function editItem(type, id) {
            editingItem = { type, id };
            const item = type === 'exercise' ? exercises.find(i => i.id === id) : foods.find(i => i.id === id);
            const isExercise = type === 'exercise';
            
            const formHTML = `
                <div class="form-group"><label>Giorno</label><select id="edit-item-day" class="form-control">${generateDayOptions(item.day)}</select></div>
                <div class="form-group"><label>Nome</label><input type="text" id="edit-item-name" class="form-control" value="${item.name}"></div>
                ${isExercise ? `
                    <div style="display:flex; gap:12px;">
                        <div class="form-group" style="flex:1;"><label>Serie</label><input type="number" id="edit-item-sets" class="form-control" value="${item.sets}"></div>
                        <div class="form-group" style="flex:1;"><label>Rip.</label><input type="text" id="edit-item-reps" class="form-control" value="${item.reps}"></div>
                        <div class="form-group" style="flex:1;"><label>Ordine</label><input type="number" id="edit-item-order" class="form-control" value="${item.order}"></div>
                    </div>
                ` : `
                    <div style="display:flex; gap:12px;">
                        <div class="form-group" style="flex:1;"><label>Quantit√† (g)</label><input type="number" id="edit-item-quantity" class="form-control" value="${item.quantity}"></div>
                        <div class="form-group" style="flex:1;"><label>Pasto</label><input type="text" id="edit-item-pasto" class="form-control" value="${item.pasto}"></div>
                    </div>
                     <div style="display:flex; gap:12px;">
                        <div class="form-group" style="flex:1;"><label>Proteine (g)</label><input type="number" id="edit-item-protein" class="form-control" value="${item.protein}"></div>
                        <div class="form-group" style="flex:1;"><label>Carboidrati (g)</label><input type="number" id="edit-item-carbs" class="form-control" value="${item.carbs}"></div>
                    </div>
                `}
                <div class="modal-actions">
                    <button onclick="closeModal()" class="btn" style="background:var(--bg-tertiary)">Annulla</button>
                    <button onclick="updateItem()" class="btn btn-primary">Salva Modifiche</button>
                </div>
            `;
            openModal(`Modifica ${isExercise ? 'Esercizio' : 'Alimento'}`, formHTML);
        }

        async function updateItem() {
            const { type, id } = editingItem;
            const isExercise = type === 'exercise';
            let updatedData = {
                day: $('#edit-item-day').value,
                name: $('#edit-item-name').value,
            };

            if (isExercise) {
                Object.assign(updatedData, {
                    sets: parseInt($('#edit-item-sets').value),
                    reps: $('#edit-item-reps').value,
                    order: parseInt($('#edit-item-order').value)
                });
            } else {
                 Object.assign(updatedData, {
                    quantity: parseInt($('#edit-item-quantity').value),
                    pasto: $('#edit-item-pasto').value,
                    protein: parseFloat($('#edit-item-protein').value),
                    carbs: parseFloat($('#edit-item-carbs').value)
                });
            }

            await updateDoc(doc(db, isExercise ? 'exercises' : 'foods', id), updatedData);
            await (isExercise ? loadExercises() : loadFoods());
            closeModal();
            showToast(`${isExercise ? 'Esercizio' : 'Alimento'} aggiornato!`, 'success');
        }
        
        function confirmDeleteItem(type, id) {
             const message = type === 'exercise' ? 'Eliminare questo esercizio?' : 'Eliminare questo alimento?';
             const content = `
                <p style="text-align:center; color: var(--label-secondary);">${message}</p>
                <div class="modal-actions">
                    <button onclick="closeModal()" class="btn" style="background:var(--bg-tertiary)">Annulla</button>
                    <button onclick="deleteItem('${type}', '${id}')" class="btn btn-danger">Conferma Elimina</button>
                </div>
             `;
             openModal('Conferma Eliminazione', content);
        }

        async function deleteItem(type, id) {
            const collectionName = type === 'exercise' ? 'exercises' : 'foods';
            await deleteDoc(doc(db, collectionName, id));
            closeModal();
            showToast('Elemento eliminato.', 'success');
            await (type === 'exercise' ? loadExercises() : loadFoods());
        }

        // --- DATA & RENDER FUNCTIONS ---
        async function loadData(collectionName, orderField = null) {
            if (!currentUser) return [];
            const args = [collection(db, collectionName), where("userId", "==", currentUser.uid)];
            if(orderField) args.push(orderBy(orderField, 'desc'));
            const q = query(...args);
            const snapshot = await getDocs(q);
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadExercises() { exercises = await loadData('exercises'); renderWorkouts(); if (currentSessionDay) loadSessionDay(currentSessionDay); }
        async function loadFoods() { foods = await loadData('foods'); renderDiet(); if (currentDietSessionDay) loadDietSessionDay(currentDietSessionDay); }

        function renderWorkouts() {
            let filtered = currentDayFilter === 'all' ? exercises : exercises.filter(ex => ex.day === currentDayFilter);
            filtered.sort((a,b) => (a.order || 999) - (b.order || 999));
            if (currentDayFilter === 'all' && filtered.length) {
                const byDay = filtered.reduce((acc, ex) => {
                    (acc[ex.day] = acc[ex.day] || []).push(ex);
                    return acc;
                }, {});
                const dayOrder = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                $('#exercises-list').innerHTML = dayOrder.filter(day => byDay[day])
                    .map(day => `<h3 class="day-header">${getDayName(day)}</h3>` + byDay[day].sort((a,b) => a.order - b.order).map(createExerciseHTML).join(''))
                    .join('');
            } else {
                 $('#exercises-list').innerHTML = filtered.length ? filtered.map(createExerciseHTML).join('') : `<div class="empty-state"><div class="empty-state-icon">üßò</div><p>Nessun esercizio qui.</p></div>`;
            }
        }

        function createExerciseHTML(ex) {
            return `
            <div class="item">
                <div class="item-header">
                    <div class="item-name">#${ex.order || '?'} ${ex.name}</div>
                    <div class="item-actions">
                        <button class="action-btn btn-edit" onclick="editItem('exercise', '${ex.id}')">‚úèÔ∏è</button>
                        <button class="action-btn btn-delete" onclick="confirmDeleteItem('exercise', '${ex.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="item-details">${ex.sets} x ${ex.reps}</div>
            </div>`;
        }
        
        function renderDiet() {
             let filtered = currentFoodDayFilter === 'all' ? foods : foods.filter(f => f.day === currentFoodDayFilter);
              if (currentFoodDayFilter === 'all' && filtered.length) {
                const byDay = filtered.reduce((acc, f) => {
                    (acc[f.day] = acc[f.day] || []).push(f);
                    return acc;
                }, {});
                const dayOrder = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                $('#foods-list').innerHTML = dayOrder.filter(day => byDay[day])
                    .map(day => `<h3 class="day-header">${getDayName(day)}</h3>` + byDay[day].map(createFoodHTML).join(''))
                    .join('');
              } else {
                $('#foods-list').innerHTML = filtered.length ? filtered.map(createFoodHTML).join('') : `<div class="empty-state"><div class="empty-state-icon">üçé</div><p>Nessun alimento qui.</p></div>`;
              }
        }

        function createFoodHTML(food) {
            return `
            <div class="item">
                <div class="item-header">
                    <div class="item-name">${food.name}</div>
                     <div class="item-actions">
                        <button class="action-btn btn-edit" onclick="editItem('food', '${food.id}')">‚úèÔ∏è</button>
                        <button class="action-btn btn-delete" onclick="confirmDeleteItem('food', '${food.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="item-details">${food.quantity}g ‚Ä¢ ${food.pasto} | P:${food.protein}g C:${food.carbs}g</div>
            </div>`;
        }
        
        // --- SESSION LOGIC ---
        async function loadSessionDay(day) {
            currentSessionDay = day;
            $$('#session-day-filter .day-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick') === `loadSessionDay('${day}')`));
            sessionExercises = exercises.filter(ex => ex.day === day).sort((a, b) => a.order - b.order);
            const sessionState = (await loadData('sessions')).find(s => s.day === day);
            completedSets = sessionState?.completedSets || {};
            renderSession();
        }

        function renderSession() {
            updateSessionProgress();
            $('#session-day-text').textContent = currentSessionDay ? `${getDayName(currentSessionDay)}` : 'Seleziona un giorno';
            const container = $('#session-exercises');

            if (!currentSessionDay) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üëÜ</div><p>Seleziona un giorno per iniziare.</p></div>`;
                return;
            }
             if (sessionExercises.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üéâ</div><p>Giorno di riposo! Nessun esercizio programmato.</p></div>`;
                return;
            }
            container.innerHTML = sessionExercises.map(ex => {
                const setsDone = completedSets[ex.id] || 0;
                const isCompleted = setsDone >= ex.sets;
                let setsHTML = Array.from({ length: ex.sets }, (_, i) => `<div class="set-indicator ${i < setsDone ? 'completed' : ''}"></div>`).join('');
                
                return `
                <div class="item session-item ${isCompleted ? 'completed' : ''}" onclick="completeOneSet('${ex.id}')">
                    <div class="item-header">
                        <div class="item-name">#${ex.order} ${ex.name}</div>
                        <div class="exercise-status">${isCompleted ? 'Fatto!' : `${setsDone}/${ex.sets}`}</div>
                    </div>
                    <div class="item-details">${ex.sets} x ${ex.reps}</div>
                    <div class="sets-progress">${setsHTML}</div>
                </div>`;
            }).join('');
             $('#reset-session-btn').classList.toggle('hidden', Object.keys(completedSets).length === 0);
        }

        async function completeOneSet(id) {
            triggerHapticFeedback();
            const exercise = sessionExercises.find(ex => ex.id === id);
            if (!exercise) return;
            let current = completedSets[id] || 0;
            completedSets[id] = (current + 1) > exercise.sets ? 0 : current + 1;
            
            const sessionDoc = (await loadData('sessions')).find(s => s.day === currentSessionDay);
            if (sessionDoc) {
                await updateDoc(doc(db, 'sessions', sessionDoc.id), { completedSets });
            } else {
                await addDoc(collection(db, 'sessions'), { userId: currentUser.uid, day: currentSessionDay, completedSets });
            }
            renderSession();
        }

        function updateSessionProgress() {
            if (!currentSessionDay) return;
            const total = sessionExercises.length;
            const completed = sessionExercises.filter(ex => (completedSets[ex.id] || 0) >= ex.sets).length;
            $('#session-progress-text').textContent = `${completed} / ${total} Esercizi Fatti`;
            $('#session-progress-fill').style.width = total > 0 ? `${(completed/total)*100}%` : '0%';
        }
        
        function resetSession() {
             openModal('Conferma Reset', `
                <p style="text-align:center; color:var(--label-secondary)">Azzerare i progressi di oggi?</p>
                <div class="modal-actions">
                    <button onclick="closeModal()" class="btn" style="background:var(--bg-tertiary)">Annulla</button>
                    <button onclick="confirmResetSession()" class="btn btn-danger">Azzera</button>
                </div>
            `);
        }
        
        async function confirmResetSession() {
             completedSets = {};
             const sessionDoc = (await loadData('sessions')).find(s => s.day === currentSessionDay);
             if (sessionDoc) await updateDoc(doc(db, 'sessions', sessionDoc.id), { completedSets });
             renderSession();
             closeModal();
             showToast('Sessione azzerata.');
        }

        // --- DIET SESSION LOGIC ---
        async function loadDietSessionDay(day) {
            currentDietSessionDay = day;
            $$('#dietsession-day-filter .day-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick') === `loadDietSessionDay('${day}')`));
            sessionFood = foods.filter(f => f.day === day);
            const dietSessionState = (await loadData('sessionsdiet')).find(s => s.day === day);
            completedFoods = dietSessionState?.completedFoods || [];
            renderDietSession();
        }

        function renderDietSession() {
            updateDietProgress();
            $('#dietsession-day-text').textContent = currentDietSessionDay ? `Dieta di ${getDayName(currentDietSessionDay)}` : 'Seleziona un giorno';
            const container = $('#session-diet');

            if (!currentDietSessionDay) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üëÜ</div><p>Seleziona un giorno.</p></div>`; return;
            }
            if (sessionFood.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><p>Nessun alimento programmato.</p></div>`; return;
            }

            container.innerHTML = sessionFood.map(food => {
                const isCompleted = completedFoods.includes(food.id);
                return `
                <div class="item session-item ${isCompleted ? 'completed' : ''}" onclick="toggleDietCompletion('${food.id}')">
                    <div class="item-header">
                        <div class="item-name">${food.name}</div>
                        <div class="food-status">${isCompleted ? 'Fatto!' : 'Da mangiare'}</div>
                    </div>
                    <div class="item-details">${food.quantity}g ‚Ä¢ ${food.pasto}</div>
                </div>`;
            }).join('');
            $('#reset-diet-session-btn').classList.toggle('hidden', completedFoods.length === 0);
        }
        
        async function toggleDietCompletion(foodId) {
            triggerHapticFeedback();
            const index = completedFoods.indexOf(foodId);
            if (index > -1) { completedFoods.splice(index, 1); } else { completedFoods.push(foodId); }
            
            const dietSessionDoc = (await loadData('sessionsdiet')).find(s => s.day === currentDietSessionDay);
            if (dietSessionDoc) {
                await updateDoc(doc(db, 'sessionsdiet', dietSessionDoc.id), { completedFoods });
            } else {
                await addDoc(collection(db, 'sessionsdiet'), { userId: currentUser.uid, day: currentDietSessionDay, completedFoods });
            }
            renderDietSession();
        }

        function updateDietProgress() {
            if (!currentDietSessionDay) return;
            const total = sessionFood.length;
            const completed = completedFoods.length;
            $('#diet-progress-text').textContent = `${completed} / ${total} Pasti Fatti`;
            $('#diet-progress-fill').style.width = total > 0 ? `${(completed/total)*100}%` : '0%';
        }
        
        function resetDietSession() {
            openModal('Conferma Reset', `
                <p style="text-align:center; color:var(--label-secondary)">Azzerare i progressi della dieta di oggi?</p>
                <div class="modal-actions">
                    <button onclick="closeModal()" class="btn" style="background:var(--bg-tertiary)">Annulla</button>
                    <button onclick="confirmResetDietSession()" class="btn btn-danger">Azzera</button>
                </div>
            `);
        }

        async function confirmResetDietSession() {
            completedFoods = [];
            const dietSessionDoc = (await loadData('sessionsdiet')).find(s => s.day === currentDietSessionDay);
            if (dietSessionDoc) await updateDoc(doc(db, 'sessionsdiet', dietSessionDoc.id), { completedFoods });
            renderDietSession();
            closeModal();
            showToast('Dieta di oggi azzerata.');
        }

        // --- HISTORY/ARCHIVE FUNCTIONS ---
        async function loadArchivedWorkouts() {
            const archives = await loadData('archivedWorkouts', 'archiveDate');
            renderArchives(archives);
        }

        function renderArchives(archives) {
            const container = $('#archive-list');
            if (!archives || archives.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üóÇÔ∏è</div><p>Nessun allenamento archiviato.</p></div>`;
                return;
            }
            container.innerHTML = archives.map(archive => {
                const date = new Date(archive.archiveDate.seconds * 1000).toLocaleString('it-IT', { dateStyle: 'long', timeStyle: 'short'});
                return `
                    <div class="item">
                        <div class="item-header">
                            <div class="item-name">Archivio del ${date}</div>
                        </div>
                        <div class="item-details">${archive.exercises.length} esercizi</div>
                        <div class="modal-actions" style="margin-top:16px;">
                            <button class="btn" style="background: var(--ios-blue);" onclick="confirmRestoreWorkout('${archive.id}')">Ripristina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function confirmArchive() {
            if (exercises.length === 0) return showToast('Nessun esercizio da archiviare.', 'error');
            openModal('Conferma Archiviazione', `
                <p style="text-align:center; color:var(--label-secondary)">Stai per archiviare la scheda corrente e svuotarla. Vuoi continuare?</p>
                <div class="modal-actions">
                    <button onclick="closeModal()" class="btn" style="background:var(--bg-tertiary)">Annulla</button>
                    <button onclick="archiveCurrentWorkout()" class="btn btn-primary">Conferma</button>
                </div>
            `);
        }
        
        async function archiveCurrentWorkout() {
            closeModal();
            showLoading(true);
            const exercisesToArchive = exercises.map(({id, userId, ...rest}) => rest); // Rimuove id e userId
            await addDoc(collection(db, 'archivedWorkouts'), {
                userId: currentUser.uid,
                archiveDate: new Date(),
                exercises: exercisesToArchive
            });

            const batch = writeBatch(db);
            exercises.forEach(ex => batch.delete(doc(db, 'exercises', ex.id)));
            await batch.commit();
            
            await Promise.all([loadExercises(), loadArchivedWorkouts()]);
            showLoading(false);
            showToast('Allenamento archiviato con successo!', 'success');
        }
        
        function confirmRestoreWorkout(archiveId) {
             openModal('Conferma Ripristino', `
                <p style="text-align:center; color:var(--label-secondary)">La tua scheda attuale verr√† sovrascritta. Vuoi continuare?</p>
                <div class="modal-actions">
                    <button onclick="closeModal()" class="btn" style="background:var(--bg-tertiary)">Annulla</button>
                    <button onclick="restoreWorkout('${archiveId}')" class="btn btn-danger">Sovrascrivi e Ripristina</button>
                </div>
            `);
        }

        async function restoreWorkout(archiveId) {
            closeModal();
            showLoading(true);
            
            // 1. Delete current exercises
            const deleteBatch = writeBatch(db);
            exercises.forEach(ex => deleteBatch.delete(doc(db, 'exercises', ex.id)));
            await deleteBatch.commit();
            
            // 2. Fetch archived exercises
            const archiveDoc = await getDocs(query(collection(db, 'archivedWorkouts'), where('__name__', '==', archiveId)));
            const archivedExercises = archiveDoc.docs[0].data().exercises;
            
            // 3. Add archived exercises to current schedule
            const addBatch = writeBatch(db);
            archivedExercises.forEach(ex => {
                const newDocRef = doc(collection(db, 'exercises'));
                addBatch.set(newDocRef, {...ex, userId: currentUser.uid});
            });
            await addBatch.commit();
            
            await loadExercises();
            showLoading(false);
            showToast('Allenamento ripristinato!', 'success');
            showTab('workout');
        }


        // --- EVENT HANDLERS & INITIALIZATION ---
        function showTab(tabName) {
            $$('.tab-content').forEach(t => t.classList.remove('active'));
            $$('.tab-btn').forEach(b => b.classList.remove('active'));
            $('#' + tabName + '-tab').classList.add('active');
            $(`.tab-btn[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        async function addExercise() {
            const data = {
                day: $('#exercise-day').value, name: $('#exercise-name').value,
                sets: parseInt($('#exercise-sets').value), reps: $('#exercise-reps').value,
                order: parseInt($('#exercise-order').value), userId: currentUser.uid
            };
            if (!data.day || !data.name || !data.sets || !data.reps || !data.order) return showToast('Compila tutti i campi.', 'error');
            await addDoc(collection(db, 'exercises'), data);
            showToast('Esercizio aggiunto!', 'success');
            $('#exercise-name').value = $('#exercise-reps').value = '';
            $('#exercise-order').value = parseInt(data.order) + 1;
            $('#exercise-name').focus();
            await loadExercises();
        }

        async function addFood() {
             const data = {
                day: $('#food-day').value, name: $('#food-name').value,
                quantity: parseInt($('#food-quantity').value), pasto: $('#food-pasto').value,
                protein: parseFloat($('#food-protein').value || 0), carbs: parseFloat($('#food-carbs').value || 0),
                userId: currentUser.uid
            };
            if (!data.day || !data.name || !data.quantity || !data.pasto) return showToast('Compila Giorno, Nome, Quantit√† e Pasto.', 'error');
            await addDoc(collection(db, 'foods'), data);
            showToast('Alimento aggiunto!', 'success');
             $('#food-name').value = $('#food-quantity').value = $('#food-protein').value = $('#food-carbs').value = '';
             $('#food-name').focus();
            await loadFoods();
        }
        
        function filterByDay(day) {
            currentDayFilter = day;
            $$('#workout-day-filter .day-btn').forEach(b => b.classList.remove('active'));
            $(`#workout-day-filter .day-btn[onclick="filterByDay('${day}')"]`).classList.add('active');
            renderWorkouts();
        }
        function filterFoodByDay(day) {
            currentFoodDayFilter = day;
            $$('#food-day-filter .day-btn').forEach(b => b.classList.remove('active'));
            $(`#food-day-filter .day-btn[onclick="filterFoodByDay('${day}')"]`).classList.add('active');
            renderDiet();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dayOptionsHTML = generateDayOptions();
            $('#exercise-day').innerHTML = dayOptionsHTML;
            $('#food-day').innerHTML = dayOptionsHTML;

            const dayFiltersHTML = ['all', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'].map(day => 
                `<button class="day-btn ${day==='all'?'active':''}" onclick="filterByDay('${day}')">${day==='all'?'Tutti':getDayName(day)}</button>`
            ).join('');
            $('#workout-day-filter').innerHTML = dayFiltersHTML;
            
             const foodDayFiltersHTML = ['all', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'].map(day => 
                `<button class="day-btn ${day==='all'?'active':''}" onclick="filterFoodByDay('${day}')">${day==='all'?'Tutti':getDayName(day)}</button>`
            ).join('');
             $('#food-day-filter').innerHTML = foodDayFiltersHTML;

            const sessionDayFiltersHTML = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'].map(day => 
                `<button class="day-btn" onclick="loadSessionDay('${day}')">${getDayName(day)}</button>`
            ).join('');
            $('#session-day-filter').innerHTML = sessionDayFiltersHTML;
            $('#dietsession-day-filter').innerHTML = sessionDayFiltersHTML.replaceAll('loadSessionDay', 'loadDietSessionDay');
        });

        function generateDayOptions(selectedValue = '') {
            const days = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            return `<option value="">Seleziona Giorno</option>` + days.map(day => `<option value="${day}" ${day === selectedValue ? 'selected' : ''}>${getDayName(day)}</option>`).join('');
        }

        window.switchToRegister = switchToRegister; window.switchToLogin = switchToLogin;
        window.loginUser = loginUser; window.registerUser = registerUser; window.logoutUser = logoutUser;
        window.showTab = showTab; window.loadSessionDay = loadSessionDay; window.loadDietSessionDay = loadDietSessionDay;
        window.addExercise = addExercise; window.filterByDay = filterByDay;
        window.addFood = addFood; window.filterFoodByDay = filterFoodByDay;
        window.completeOneSet = completeOneSet; window.resetSession = resetSession;
        window.confirmResetSession = confirmResetSession;
        window.toggleDietCompletion = toggleDietCompletion; window.resetDietSession = resetDietSession;
        window.confirmResetDietSession = confirmResetDietSession;
        window.closeModal = closeModal; window.editItem = editItem; window.updateItem = updateItem;
        window.deleteItem = deleteItem; window.confirmDeleteItem = confirmDeleteItem;
        window.confirmArchive = confirmArchive; window.archiveCurrentWorkout = archiveCurrentWorkout;
        window.confirmRestoreWorkout = confirmRestoreWorkout; window.restoreWorkout = restoreWorkout;

    </script>
</body>
</html>
